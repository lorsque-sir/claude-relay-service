#!/bin/bash

echo "ğŸš€ Claude Relay Service æœ¬åœ°Dockeréƒ¨ç½²è„šæœ¬ (ç¤ºä¾‹ç‰ˆæœ¬)"
echo "=========================================="

# æ£€æŸ¥ç¯å¢ƒå˜é‡
if [ -z "$REDIS_PASSWORD" ]; then
    echo "âŒ æœªè®¾ç½® REDIS_PASSWORD ç¯å¢ƒå˜é‡"
    echo "   è¯·å…ˆè®¾ç½®: export REDIS_PASSWORD='your_redis_password'"
    exit 1
fi

if [ -z "$ADMIN_PASSWORD" ]; then
    echo "âŒ æœªè®¾ç½® ADMIN_PASSWORD ç¯å¢ƒå˜é‡"
    echo "   è¯·å…ˆè®¾ç½®: export ADMIN_PASSWORD='your_admin_password'"
    exit 1
fi

# æ£€æŸ¥Dockeræ˜¯å¦è¿è¡Œ
if ! docker info >/dev/null 2>&1; then
    echo "âŒ Dockeræœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨Docker"
    exit 1
fi

# æ£€æŸ¥Redisæ˜¯å¦å¯è®¿é—®
echo "ğŸ” æ£€æŸ¥æœ¬åœ°Redisè¿æ¥..."
if command -v redis-cli >/dev/null 2>&1; then
    if redis-cli -h 127.0.0.1 -p 6379 -a "$REDIS_PASSWORD" ping >/dev/null 2>&1; then
        echo "âœ… Redisè¿æ¥æ­£å¸¸"
    else
        echo "âŒ Redisè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥RedisæœåŠ¡å’Œå¯†ç "
        echo "   å‘½ä»¤: redis-cli -h 127.0.0.1 -p 6379 -a '$REDIS_PASSWORD' ping"
        exit 1
    fi
else
    echo "âš ï¸  æœªæ‰¾åˆ°redis-cliï¼Œè·³è¿‡Redisè¿æ¥æ£€æŸ¥"
fi

# æ£€æŸ¥ä»£ç†æ˜¯å¦å¯è®¿é—®
echo "ğŸ” æ£€æŸ¥æœ¬åœ°ä»£ç†è¿æ¥..."
PROXY_HOST=${PROXY_HOST:-"127.0.0.1"}
PROXY_PORT=${PROXY_PORT:-"7897"}

if command -v curl >/dev/null 2>&1; then
    if curl --proxy "http://$PROXY_HOST:$PROXY_PORT" --connect-timeout 5 https://www.google.com >/dev/null 2>&1; then
        echo "âœ… ä»£ç†è¿æ¥æ­£å¸¸"
    else
        echo "âš ï¸  ä»£ç†è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç†æœåŠ¡ $PROXY_HOST:$PROXY_PORT"
        echo "   ç»§ç»­éƒ¨ç½²ï¼Œä»£ç†é…ç½®å°†åœ¨åº”ç”¨ä¸­å•ç‹¬è®¾ç½®"
    fi
else
    echo "âš ï¸  æœªæ‰¾åˆ°curlï¼Œè·³è¿‡ä»£ç†è¿æ¥æ£€æŸ¥"
fi

# åˆ›å»ºå¿…è¦ç›®å½•
echo "ğŸ“ åˆ›å»ºå¿…è¦ç›®å½•..."
mkdir -p logs data

# æ„å»ºå’Œå¯åŠ¨æœåŠ¡
echo "ğŸ—ï¸  æ„å»ºDockeré•œåƒ..."
docker-compose -f docker-compose.local.yml build

echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
docker-compose -f docker-compose.local.yml up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 10

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
docker-compose -f docker-compose.local.yml ps

# æ£€æŸ¥å¥åº·çŠ¶æ€
echo "ğŸ¥ æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
if curl -f http://localhost:3000/health >/dev/null 2>&1; then
    echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
    echo ""
    echo "ğŸŒ è®¿é—®ä¿¡æ¯ï¼š"
    echo "   ç®¡ç†ç•Œé¢: http://localhost:3000/admin-next/"
    echo "   APIç«¯ç‚¹:  http://localhost:3000/api/v1/messages"
    echo "   å¥åº·æ£€æŸ¥: http://localhost:3000/health"
    echo ""
    echo "ğŸ‘¤ ç®¡ç†å‘˜å‡­æ®ï¼š"
    echo "   ç”¨æˆ·å: admin"
    echo "   å¯†ç : $ADMIN_PASSWORD"
    echo ""
    echo "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
    echo "   1. è®¿é—®ç®¡ç†ç•Œé¢é…ç½®Claudeè´¦æˆ·"
    echo "   2. åœ¨è´¦æˆ·è®¾ç½®ä¸­é…ç½®ä»£ç†: $PROXY_HOST:$PROXY_PORT"
    echo "   3. å®ŒæˆOAuthæˆæƒæµç¨‹"
    echo "   4. åˆ›å»ºAPI Keyså¼€å§‹ä½¿ç”¨"
else
    echo "âŒ æœåŠ¡å¯åŠ¨å¼‚å¸¸ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
    echo "   docker-compose -f docker-compose.local.yml logs claude-relay-local"
fi

echo ""
echo "ğŸ”§ å¸¸ç”¨å‘½ä»¤ï¼š"
echo "   æŸ¥çœ‹æ—¥å¿—: docker-compose -f docker-compose.local.yml logs -f"
echo "   é‡å¯æœåŠ¡: docker-compose -f docker-compose.local.yml restart"
echo "   åœæ­¢æœåŠ¡: docker-compose -f docker-compose.local.yml down"
echo "   è¿›å…¥å®¹å™¨: docker-compose -f docker-compose.local.yml exec claude-relay-local sh"