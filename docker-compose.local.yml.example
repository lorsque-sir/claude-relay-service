version: '3.8'

# Claude Relay Service - æœ¬åœ°éƒ¨ç½²é…ç½®ç¤ºä¾‹
# ä½¿ç”¨æœ¬åœ°Rediså’Œä»£ç†æœåŠ¡
# âš ï¸  æ­¤æ–‡ä»¶ä¸åŒ…å«çœŸå®å¯†ç ï¼Œè¯·å¤åˆ¶ä¸º docker-compose.local.yml å¹¶é…ç½®å®é™…å€¼

services:
  # ğŸš€ Claude Relay Service
  claude-relay-local:
    build: .
    container_name: claude-relay-local
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
    env_file:
      - .env.local
    environment:
      # ğŸŒ æœåŠ¡å™¨é…ç½®
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0

      # ğŸ“Š Redisé…ç½®ï¼ˆè¿æ¥åˆ°å®¿ä¸»æœºRedisï¼‰
      # âš ï¸  è¯·åœ¨ .env.local æ–‡ä»¶ä¸­è®¾ç½® REDIS_PASSWORD
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=0

      # ğŸŒ å®¹å™¨çº§åˆ«ä»£ç†é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºå®¹å™¨å†…ç›´æ¥è®¿é—®å¤–ç½‘ï¼‰
      # ğŸ’¡ å¯æ ¹æ®éœ€è¦ä¿®æ”¹ä»£ç†åœ°å€å’Œç«¯å£
      - HTTP_PROXY=http://host.docker.internal:7897
      - HTTPS_PROXY=http://host.docker.internal:7897
      - NO_PROXY=localhost,127.0.0.1,host.docker.internal
    extra_hosts:
      # å…è®¸å®¹å™¨è®¿é—®å®¿ä¸»æœºæœåŠ¡
      - "host.docker.internal:host-gateway"
    networks:
      - claude-relay-local
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ğŸ“ˆ Redisç›‘æ§å·¥å…·ï¼ˆå¯é€‰ï¼‰
  redis-commander-local:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander-local
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      # âš ï¸  è¯·åœ¨ .env.local æ–‡ä»¶ä¸­è®¾ç½® REDIS_PASSWORD
      - REDIS_HOSTS=local:host.docker.internal:6379:0:${REDIS_PASSWORD}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - claude-relay-local
    profiles:
      - monitoring

networks:
  claude-relay-local:
    driver: bridge